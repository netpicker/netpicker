x-api: &api_common
  image: "netpicker/api:0.0.28-rc"
  environment:
    alembic_version: "0fa5ec0be9fc"
    ALLOWED_ORIGINS: '["*"]'
    AUTH_BACKEND: netyce_alchemy
    BEAT_DB_URI: "postgresql+psycopg2://netpicker:netpicker@db/netpicker"
    CELERY_BROKER_URL: redis://redis
    CELERY_RESULT_BACKEND: redis://redis
    CLI_PROXY_HOST: agent
    DB_URI: "postgresql+asyncpg://netpicker:netpicker@db/netpicker"
    GIT_SERVER: git://gitd
    GIT_REPO_MANAGER: '["gitdctrl",9419]'
    INIT_USER: 'admin@admin.com'
    INIT_PASSWORD: '12345678'
    INIT_TENANT: 'default'
    JWT_AUDIENCE: "netpicker"
    JWT_ALGORITHM: HS256
    JWT_SECRET: ew9023cnkljfcnsdlkfsfdhs
    LOG_LEVEL: INFO
    PERSISTENT_VOLUME_PATH: /data/policy-repository
    REDIS_URL: redis://redis
    UVICORN_ROOT_PATH: /
    WORKDIR_VOLUME_PATH: /data/policy-workdir
  volumes:
    - policy-data:/data
  depends_on:
    redis:
      condition: service_healthy
    db:
      condition: service_healthy
    gitd:
      condition: service_started
    gitdctrl:
      condition: service_healthy

services:
  db:
    image: netpicker/db
    container_name: db
    labels:
      netpicker.io: service
    ports:
      - 5432:5432
    environment:
      POSTGRES_PASSWORD: s3rgts0p!
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready", "-d", "db_prod"]
      interval: 30s
      timeout: 60s
      retries: 5
      start_period: 80s

  api:
    <<: *api_common
    container_name: api
    labels:
      netpicker.io: service
      service.netpicker.io: api
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/status"]
      start_period: 60s
      interval: 5s

  celery:
    <<: *api_common
    container_name: celery
    labels:
      netpicker.io: service
      service.netpicker.io: celery
    command: /run-celery
    healthcheck:
      test: ["CMD", "celery", "inspect", "ping", "-t", "5"]
      start_period: 10s
      interval: 30s

  redis:
    image: redis:7-alpine
    container_name: redis
    labels:
      netpicker.io: service
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]

  gitd:
    image: "netpicker/gitd:0.0.28-rc"
    user: 911:911
    container_name: gitd
    labels:
      netpicker.io: service
      service.netpicker.io: gitd
    ports:
      - "9418:9418" # Default port for git:// pull/push
    volumes:
      - git:/git:z

  gitdctrl:
    image: "netpicker/gitdctrl:0.0.28-rc"
    user: 911:911
    container_name: gitdctrl
    labels:
      netpicker.io: service
      service.netpicker.io: gitdctrl
    ports:
      - "9419:9419"
    volumes:
      - git:/git
    healthcheck:
      test: echo "PING" | nc -v localhost 9419
      start_period: 5s
      interval: 5s
    restart: unless-stopped

  swagger:
    image: swaggerapi/swagger-ui
    container_name: swagger
    environment:
      SWAGGER_JSON_URL: "/openapi.json"
      TRY_IT_OUT_ENABLED: 1
    ports:
      - "8080:8080"
    depends_on:
      - api

  frontend:
    image: "netpicker/frontend:0.0.28-rc"
    container_name: frontend
    labels:
      netpicker.io: service
      service.netpicker.io: front-end
    ports:
      - "80:80"
    depends_on:
      - api

  kibbitzer:
    image: "netpicker/kibbitzer:0.0.28-rc"
    container_name: kibbitzer
    labels:
      netpicker.io: service
      service.netpicker.io: kibbitzer
    environment:
      SHENV_API_URL: http://api:8000
      LOG_LEVEL: DEBUG
    healthcheck:
      test: echo "ping Mac\n" | nc -v 127.0.0.1 9696
      start_period: 15s
      interval: 30s
    volumes:
      - secret:/run/secrets
    depends_on:
      - api
      - redis

  agent:
    hostname: agent
    image: "netpicker/agent:0.0.28-rc"
    container_name: agent
    labels:
      netpicker.io: service
      service.netpicker.io: agent
    environment:
      CLI_PROXY_ADDR: '0.0.0.0'
      # CLI_TRACE_DIR: /tmp/trace-cli
      # DEDICATED_CONNECTIONS: 1
      # SHENV_JUMP_HOST: '192.168.60.3'
      SHENV_PRIVILEGED_PLATFORMS: 'privileged_platform'
      SHENV_SHOW_RUN_nokia_srl: 'info'
      SHARED_SSH_TTL: 180
    volumes:
      - config:/agent-config
      - secret:/run/secrets
      - transferium:/transferium
    ports:
      - 9876:9876/tcp
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: "echo LST | nc -v 127.0.0.1 8765"
      start_period: 12s
      interval: 10s

  syslog-ng:
    image: "netpicker/syslog_ng:0.0.28-rc"
    labels:
      netpicker.io: service
      service.netpicker.io: syslog-ng
    user: 911:911
    ports:
      - 5514:514/udp
      - 6601:601/tcp
      - 6514:6614/tcp
    volumes:
      - syslog:/var/lib/syslog-ng
    depends_on:
      - agent

volumes:
  config:
  git:
  pg_data:
  policy-data:
  secret:
  syslog:
  transferium:
